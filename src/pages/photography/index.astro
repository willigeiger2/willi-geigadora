---
import Layout from '../../layouts/Layout.astro';
import NavBar from '../../components/NavBar.astro';
---

<Layout title="Photography">
  <main>
    <NavBar />
    <div class="page">
      <div id="thumbs" class="thumbs" aria-live="polite"></div>
      <div id="sentinel" class="sentinel" aria-hidden="true"></div>
    </div>
  </main>
</Layout>

<style>
  main {
    position: absolute;
    top: 0;
    bottom: 0;
    left: 0;
    right: 0;
    width: 100%;
    height: 100%;
    color: white;
    background-color: #000;
  }
  .page {
    box-sizing: border-box;
    padding: 5.5rem 5vw 2rem; /* account for fixed navbar */
  }
  h1 {
    margin: 0 0 1rem 0;
    font-weight: 600;
  }
  .thumbs {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
    gap: 0.75rem;
    align-items: start;
  }
  .thumb {
    display: flex;
    align-items: center;
    justify-content: center;
    border: 1px solid rgba(255,255,255,0.2);
    border-radius: 6px;
    padding: 6px;
    background: rgba(0,0,0,0.2);
    overflow: hidden; /* contain content */
    transform-origin: center;
  }
  .thumb img {
    display: block;
    height: 240px; /* fixed height */
    width: auto; /* preserve aspect ratio */
    object-fit: contain; /* do not crop */
    border-radius: 4px;
    transition: transform 120ms ease;
  }
  .thumb:hover img { transform: scale(1.03); }
  .sentinel { height: 1px; }
</style>

<style is:global>
  html, body {
    background-color: #000;
    background-image: none;
  }
  /* Make gallery styles global so dynamically-created nodes are styled */
  .thumbs {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 0.75rem;
    align-items: start;
  }
  .thumb {
    display: flex;
    align-items: center;
    justify-content: center;
    border: 1px solid rgba(255,255,255,0.2);
    border-radius: 6px;
    padding: 6px;
    background: rgba(0,0,0,0.2);
    transition: transform 120ms ease;
    overflow: hidden;
    transform-origin: center;
  }
  .thumb:hover { transform: scale(1.03); }
  .thumb img {
    display: block;
    height: 240px;
    width: auto;
    max-width: 240px;
    object-fit: contain;
    border-radius: 4px;
  }
</style>

<script>
  type ImgItem = { id: string, filename?: string, variants?: string[] };

  let images: ImgItem[] = [];
  let rendered = 0;
  const BATCH_SIZE = 60;

  function pickThumbVariant(item: ImgItem): string {
    const vs = Array.isArray(item.variants) ? item.variants : [];
    if (vs.length === 0) return '';
    return vs[0] || vs[vs.length - 1];
  }

  function renderBatch() {
    const container = document.getElementById('thumbs') as HTMLDivElement | null;
    if (!container) return;
    const end = Math.min(rendered + BATCH_SIZE, images.length);
    const frag = document.createDocumentFragment();
    for (let i = rendered; i < end; i++) {
      const img = images[i] as any;
      const a = document.createElement('a');
      a.href = `/photography/${encodeURIComponent(img.id)}`;
      a.className = 'thumb';
      const el = document.createElement('img');
      el.loading = 'lazy';
      el.alt = img.filename || img.id;
      el.src = pickThumbVariant(img);
      el.setAttribute('height', '240');
      el.style.height = '240px';
      el.style.width = 'auto';
      el.style.maxWidth = '240px';
      a.appendChild(el);
      frag.appendChild(a);
    }
    container.appendChild(frag);
    rendered = end;
  }

  function setupObserver() {
    const sentinel = document.getElementById('sentinel');
    if (!sentinel) return;
    const io = new IntersectionObserver((entries) => {
      for (const entry of entries) {
        if (entry.isIntersecting) {
          if (rendered < images.length) {
            renderBatch();
          }
        }
      }
    });
    io.observe(sentinel);
  }

  async function loadImages() {
    const container = document.getElementById('thumbs') as HTMLDivElement | null;
    if (container) container.innerHTML = '';
    try {
      // Try cache first
      try {
        const cached = sessionStorage.getItem('cf_images');
        if (cached) {
          const parsed = JSON.parse(cached);
          if (Array.isArray(parsed)) {
            images = parsed as ImgItem[];
          }
        }
      } catch {}

      // Fallback to API
      if (!Array.isArray(images) || images.length === 0) {
        const res = await fetch('/api/images');
        if (!res.ok) throw new Error('Failed to load images');
        const data: any = await res.json();
        images = (data && Array.isArray(data.images)) ? data.images : [];
        try { sessionStorage.setItem('cf_images', JSON.stringify(images)); } catch {}
      }

      rendered = 0;
      renderBatch();
      setupObserver();
    } catch (e) {
      if (container) container.textContent = 'Error loading images';
      console.error(e);
    }
  }

  loadImages();
</script>
